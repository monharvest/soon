<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Added marked.js for markdown support -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- Login Screen -->
        <div id="loginScreen" class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-8 rounded-lg shadow-md w-96">
                <h1 class="text-2xl font-bold mb-6 text-center">Admin Login</h1>
                <input type="password" id="tokenInput" placeholder="Enter admin token" 
                       class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                    Login
                </button>
                <div id="loginError" class="text-red-500 text-sm mt-2 hidden"></div>
            </div>
        </div>

        <!-- Main Admin Panel -->
        <div id="adminPanel" class="hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b">
                <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                    <h1 class="text-2xl font-bold">Blog Admin</h1>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700">Logout</button>
                </div>
            </header>

            <!-- Two-column layout: posts list on left, editor on right -->
            <div class="container mx-auto px-4 py-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column: Posts List by Category -->
                    <div class="bg-white rounded-lg shadow-md p-6 h-[calc(100vh-12rem)] overflow-y-auto">
                        <h2 class="text-xl font-bold mb-4">All Posts</h2>
                        <div id="postsContainer">
                            <div class="text-center text-gray-500 py-8">Loading posts...</div>
                        </div>
                    </div>

                    <!-- Right Column: Post Editor -->
                    <div class="bg-white rounded-lg shadow-md p-6 h-[calc(100vh-12rem)] overflow-y-auto">
                        <h2 class="text-xl font-bold mb-4" id="editorTitle">New Post</h2>
                        
                        <form id="postForm" class="space-y-4">
                            <input type="hidden" id="postKey">
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Title</label>
                                <input type="text" id="postTitle" required 
                                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Slug</label>
                                <input type="text" id="postSlug" required 
                                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Category</label>
                                <select id="postCategory" required 
                                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select a category</option>
                                    <option value="Сайн мэдээ">Сайн мэдээ</option>
                                    <option value="Advent">Advent</option>
                                    <option value="Сургаалт зүйрлэлүүд">Сургаалт зүйрлэлүүд</option>
                                    <option value="Үхэл ба амилал">Үхэл ба амилал</option>
                                    <option value="Мөнх үгийн ойлголт">Мөнх үгийн ойлголт</option>
                                    <option value="Тамын тухай">Тамын тухай</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Excerpt</label>
                                <textarea id="postExcerpt" rows="2" required 
                                          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>

                            <!-- Added markdown editor with preview toggle -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="block text-sm font-medium">Content (Markdown)</label>
                                    <button type="button" onclick="toggleMarkdownPreview()" 
                                            class="text-xs text-blue-600 hover:text-blue-700">
                                        Toggle Preview
                                    </button>
                                </div>
                                <textarea id="postContent" rows="8" required 
                                          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                                <div id="markdownPreview" class="hidden mt-2 p-4 border rounded-lg bg-gray-50 prose prose-sm max-w-none"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Meta Description</label>
                                <textarea id="postMetaDescription" rows="2" 
                                          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-1">Featured Image</label>
                                <div class="flex space-x-2 mb-2">
                                    <input type="file" id="imageUpload" accept="image/*" 
                                           class="flex-1 px-4 py-2 border rounded-lg text-sm">
                                    <button type="button" onclick="openImagePicker()" 
                                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm whitespace-nowrap">
                                        Browse Images
                                    </button>
                                </div>
                                <div id="uploadProgress" class="hidden mt-2 text-sm text-blue-600">Uploading...</div>
                                <div id="imagePreview" class="mt-2 hidden">
                                    <img id="previewImg" class="max-w-full h-32 object-cover rounded-lg">
                                </div>
                                <input type="hidden" id="postImage">
                            </div>

                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="postPublished" class="mr-2">
                                    <span class="text-sm">Published</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="postFeatured" class="mr-2">
                                    <span class="text-sm">Featured</span>
                                </label>
                            </div>

                            <div class="flex space-x-4">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                    Save Post
                                </button>
                                <button type="button" onclick="clearForm()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300">
                                    Clear
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Added Image Picker Modal -->
    <div id="imagePickerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold">Select Image from R2</h2>
                <button onclick="closeImagePicker()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="imagePickerContent" class="flex-1 overflow-y-auto p-4">
                <div class="text-center text-gray-500 py-8">Loading images...</div>
            </div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = "https://admin-api.monharvest.workers.dev";
        const R2_PUBLIC_URL = "https://pub-80ac1ffe1f8642ef8d334e6dc0ace7d3.r2.dev";
        
        let authToken = localStorage.getItem("adminToken");
        let allPosts = [];

        // Initialize
        if (authToken) {
            showAdminPanel();
        }

        async function login() {
            const token = document.getElementById("tokenInput").value;
            if (!token) {
                showError("loginError", "Please enter a token");
                return;
            }

            try {
                const res = await fetch(`${API_ENDPOINT}/posts`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                
                if (res.ok) {
                    authToken = token;
                    localStorage.setItem("adminToken", token);
                    showAdminPanel();
                } else {
                    showError("loginError", "Invalid token or unauthorized");
                    localStorage.removeItem("adminToken");
                }
            } catch (error) {
                showError("loginError", "Failed to connect to API: " + error.message);
            }
        }

        function logout() {
            localStorage.removeItem("adminToken");
            authToken = null;
            location.reload();
        }

        function showAdminPanel() {
            document.getElementById("loginScreen").classList.add("hidden");
            document.getElementById("adminPanel").classList.remove("hidden");
            loadPosts();
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove("hidden");
        }

        async function loadPosts() {
            const container = document.getElementById("postsContainer");
            
            try {
                const res = await fetch(`${API_ENDPOINT}/posts`, {
                    headers: { "Authorization": `Bearer ${authToken}` }
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const result = await res.json();
                const keys = result.keys || [];
                
                if (keys.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8">No posts found. Create your first post!</div>';
                    return;
                }
                
                // Fetch all post data
                allPosts = await Promise.all(
                    keys.map(async (key) => {
                        try {
                            const postRes = await fetch(`${API_ENDPOINT}/posts/${key}`, {
                                headers: { "Authorization": `Bearer ${authToken}` }
                            });
                            if (postRes.ok) {
                                const post = await postRes.json();
                                return { key, ...post };
                            }
                        } catch (e) {
                            console.error("Failed to load post:", key, e);
                        }
                        return null;
                    })
                );
                
                allPosts = allPosts.filter(p => p !== null);
                
                // Group by category
                const categories = {};
                allPosts.forEach(post => {
                    const cat = post.category || 'Uncategorized';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(post);
                });
                
                // Render grouped posts
                container.innerHTML = Object.entries(categories).map(([category, posts]) => `
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-2 text-gray-700 border-b pb-1">${escapeHtml(category)}</h3>
                        <div class="space-y-2">
                            ${posts.map(post => `
                                <div class="p-3 border rounded-lg hover:bg-gray-50 cursor-pointer" onclick="editPostByKey('${escapeHtml(post.key)}')">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h4 class="font-medium text-sm">${escapeHtml(post.title)}</h4>
                                            <p class="text-xs text-gray-500 mt-1">${escapeHtml(decodeURIComponent(post.key))}</p>
                                        </div>
                                        <button onclick="event.stopPropagation(); deletePost('${escapeHtml(post.key)}')" 
                                                class="text-red-600 hover:text-red-700 text-xs ml-2">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="text-red-800 font-bold mb-2">Failed to load posts</h3>
                        <p class="text-red-600 text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function editPostByKey(key) {
            const post = allPosts.find(p => p.key === key);
            if (!post) {
                alert("Post not found");
                return;
            }
            
            document.getElementById("postKey").value = key;
            document.getElementById("postTitle").value = post.title || "";
            document.getElementById("postSlug").value = post.slug || "";
            document.getElementById("postCategory").value = post.category || "";
            document.getElementById("postExcerpt").value = post.excerpt || "";
            document.getElementById("postContent").value = post.content || "";
            document.getElementById("postMetaDescription").value = post.metaDescription || "";
            document.getElementById("postImage").value = post.image || "";
            document.getElementById("postPublished").checked = post.published !== false;
            document.getElementById("postFeatured").checked = post.featured || false;
            
            if (post.image) {
                const fullImageUrl = post.image.startsWith('http') ? post.image : `${R2_PUBLIC_URL}${post.image}`;
                document.getElementById("previewImg").src = fullImageUrl;
                document.getElementById("imagePreview").classList.remove("hidden");
            } else {
                document.getElementById("imagePreview").classList.add("hidden");
            }
            
            document.getElementById("editorTitle").textContent = "Edit Post";
            
            // Scroll to top of editor
            document.querySelector('#postForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function deletePost(key) {
            if (!confirm("Are you sure you want to delete this post?")) return;
            
            try {
                await fetch(`${API_ENDPOINT}/posts/${key}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${authToken}` }
                });
                
                loadPosts();
            } catch (error) {
                alert("Failed to delete post: " + error.message);
            }
        }

        function clearForm() {
            document.getElementById("postForm").reset();
            document.getElementById("postKey").value = "";
            document.getElementById("postPublished").checked = true;
            document.getElementById("imagePreview").classList.add("hidden");
            document.getElementById("editorTitle").textContent = "New Post";
            document.getElementById("markdownPreview").classList.add("hidden");
        }

        function toggleMarkdownPreview() {
            const preview = document.getElementById("markdownPreview");
            const content = document.getElementById("postContent").value;
            
            if (preview.classList.contains("hidden")) {
                preview.innerHTML = marked.parse(content);
                preview.classList.remove("hidden");
            } else {
                preview.classList.add("hidden");
            }
        }

        document.getElementById("imageUpload").addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                document.getElementById("uploadProgress").classList.remove("hidden");

                const formData = new FormData();
                formData.append("image", file);

                const res = await fetch(`${API_ENDPOINT}/upload-image`, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${authToken}` },
                    body: formData
                });

                if (!res.ok) {
                    throw new Error("Upload failed");
                }

                const data = await res.json();
                
                let cleanUrl = data.url;
                if (cleanUrl.startsWith('http')) {
                    cleanUrl = cleanUrl.substring(cleanUrl.indexOf('/posts'));
                }
                
                document.getElementById("postImage").value = cleanUrl;
                
                const fullImageUrl = `${R2_PUBLIC_URL}${cleanUrl}`;
                document.getElementById("previewImg").src = fullImageUrl;
                document.getElementById("imagePreview").classList.remove("hidden");
                document.getElementById("uploadProgress").classList.add("hidden");
            } catch (error) {
                alert("Failed to upload image: " + error.message);
                document.getElementById("uploadProgress").classList.add("hidden");
            }
        });

        document.getElementById("postForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            try {
                const key = document.getElementById("postKey").value;
                const slug = document.getElementById("postSlug").value;
                
                const targetSlug = key || slug;

                const postData = {
                    id: key ? undefined : crypto.randomUUID(),
                    title: document.getElementById("postTitle").value,
                    slug: slug,
                    category: document.getElementById("postCategory").value,
                    excerpt: document.getElementById("postExcerpt").value,
                    content: document.getElementById("postContent").value,
                    metaDescription: document.getElementById("postMetaDescription").value,
                    image: document.getElementById("postImage").value,
                    date: new Date().toLocaleDateString('en-US'),
                    published: document.getElementById("postPublished").checked,
                    featured: document.getElementById("postFeatured").checked,
                };

                const res = await fetch(`${API_ENDPOINT}/posts/${targetSlug}`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${authToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(postData)
                });

                if (!res.ok) {
                    throw new Error("Failed to save post");
                }

                clearForm();
                loadPosts();
                alert("Post saved successfully!");
            } catch (error) {
                alert("Failed to save post: " + error.message);
            }
        });

        document.getElementById("postTitle").addEventListener("input", (e) => {
            if (!document.getElementById("postKey").value) {
                const slug = e.target.value
                    .toLowerCase()
                    .replace(/[^\w\s\u0400-\u04FF-]/gu, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .trim();
                document.getElementById("postSlug").value = slug;
            }
        });

        async function openImagePicker() {
            const modal = document.getElementById("imagePickerModal");
            const content = document.getElementById("imagePickerContent");
            
            modal.classList.remove("hidden");
            content.innerHTML = '<div class="text-center text-gray-500 py-8">Loading images...</div>';
            
            try {
                console.log("[v0] Fetching images from:", `${API_ENDPOINT}/images`);
                
                const res = await fetch(`${API_ENDPOINT}/images`, {
                    headers: { "Authorization": `Bearer ${authToken}` }
                });
                
                console.log("[v0] Images response status:", res.status);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.log("[v0] Images error response:", errorText);
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }
                
                const data = await res.json();
                console.log("[v0] Images data:", data);
                
                const images = data.images || [];
                
                if (images.length === 0) {
                    content.innerHTML = '<div class="text-center text-gray-500 py-8">No images found. Upload your first image!</div>';
                    return;
                }
                
                // Sort by upload date (newest first)
                images.sort((a, b) => new Date(b.uploaded) - new Date(a.uploaded));
                
                content.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${images.map(img => `
                            <div class="border rounded-lg overflow-hidden hover:shadow-lg transition-shadow cursor-pointer"
                                 onclick="selectImage('${escapeHtml(img.url)}')">
                                <img src="${R2_PUBLIC_URL}${escapeHtml(img.url)}" 
                                     alt="Image" 
                                     class="w-full h-32 object-cover">
                                <div class="p-2 bg-gray-50">
                                    <p class="text-xs text-gray-600 truncate">${escapeHtml(img.key.split('/').pop())}</p>
                                    <p class="text-xs text-gray-400">${formatFileSize(img.size)}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error("[v0] Failed to load images:", error);
                content.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="text-red-800 font-bold mb-2">Failed to load images</h3>
                        <p class="text-red-600 text-sm mb-2">${error.message}</p>
                        <p class="text-xs text-gray-600">Check the browser console for more details.</p>
                    </div>
                `;
            }
        }
        
        function closeImagePicker() {
            document.getElementById("imagePickerModal").classList.add("hidden");
        }
        
        function selectImage(url) {
            document.getElementById("postImage").value = url;
            document.getElementById("previewImg").src = `${R2_PUBLIC_URL}${url}`;
            document.getElementById("imagePreview").classList.remove("hidden");
            closeImagePicker();
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
    </script>
</body>
</html>
